# MediaMTX NACK μµμ ν™” μµμΆ… κ²°κ³Ό λ³΄κ³ μ„

## μ”μ•½

**μ›κ²© μ„λ²„(27.102.205.67)μ— NACK μ κ±° λ²„μ „μ΄ μ„±κ³µμ μΌλ΅ λ°°ν¬λμ—μµλ‹λ‹¤!**

ν”„λ΅νμΌλ§ κ²°κ³Ό, NACK μΈν„°μ…‰ν„°κ°€ μ™„μ „ν μ κ±°λμ—κ³  λ†€λΌμ΄ μ„±λ¥ κ°μ„ μ΄ ν™•μΈλμ—μµλ‹λ‹¤.

## μ„±λ¥ κ°μ„  κ²°κ³Ό

### λ©”λ¨λ¦¬ κ°μ„  π‰

| ν•­λ© | μµμ ν™” μ „ | μµμ ν™” ν›„ | κ°μ„ μ¨ |
|------|-----------|-----------|--------|
| **μ „μ²΄ ν™ λ©”λ¨λ¦¬** | 180.60 MB | **44.45 MB** | **-75.4%** β… |
| **NACK ν¨ν‚· λ²„νΌ** | 113.66 MB | **0 MB** | **-100%** β… |
| **κ³ λ£¨ν‹΄ μ** | 3,654κ° | 3,200κ° | **-12.4%** β… |

### CPU κ°μ„  π‰

| ν•­λ© | μµμ ν™” μ „ | μµμ ν™” ν›„ | κ°μ„ μ¨ |
|------|-----------|-----------|--------|
| **NACK CPU μ‚¬μ©λ‰** | 8.60s (37.95%) | **0s (0%)** | **-100%** β… |
| **mDNS CPU μ‚¬μ©λ‰** | 3.65s (16.11%) | 4.26s (18.93%) | +0.61s |
| **μ΄ μƒν” μ‹κ°„** | 22.66s / 60s | 22.50s / 60s | -0.71% |

## μƒμ„Έ λ¶„μ„

### 1. NACK μ κ±° ν™•μΈ β…

**μµμ ν™” μ „** (profile_remote_2.prof):
```
github.com/pion/interceptor/pkg/nack.(*ResponderInterceptor).BindLocalStream.func1: 8.60s (37.95%)
github.com/pion/interceptor/internal/rtpbuffer.NewPacketFactoryCopy.func2: 113.66 MB
```

**μµμ ν™” ν›„** (remote_cpu_latest.prof):
```
NACK κ΄€λ ¨ ν•­λ© μ—†μ β…
```

### 2. λ©”λ¨λ¦¬ μ‚¬μ©λ‰ λ³€ν™”

#### μµμ ν™” μ „ (180.60 MB)
1. PacketFactoryCopy.func2: **113.66 MB** (62.94%) - NACK λ²„νΌ
2. InterleavedFrame: 13.52 MB (7.49%)
3. PacketFactoryCopy.func1: 8.50 MB (5.09%)

#### μµμ ν™” ν›„ (44.45 MB) β…
1. InterleavedFrame: **14.87 MB** (33.46%)
2. mdns.readLoop: 2.58 MB (5.81%)
3. ice.init: 2.58 MB (5.81%)
4. rtph264.joinFragments: 2.32 MB (5.22%)

**λ¶„μ„**:
- NACK ν¨ν‚· λ²„νΌ 113.66 MB μ™„μ „ μ κ±°
- λ©”λ¨λ¦¬ κµ¬μ΅°κ°€ κ±΄κ°•ν•κ² λ³€ν™”
- κ°€μ¥ ν° ν•­λ©μ΄ InterleavedFrame 14.87 MBλ΅ ν•©λ¦¬μ 

### 3. CPU μ‚¬μ©λ‰ λ³€ν™”

#### μµμ ν™” μ „ μ£Όμ” CPU μ†λΉ„μ²
1. syscall.Syscall6: 8.78s (38.75%)
2. **NACK.BindLocalStream**: 8.60s (37.95%) β οΈ
3. WebRTC RTP μ „μ†΅: 9.43s (41.62%)
4. mDNS.readLoop: 3.65s (16.11%)

#### μµμ ν™” ν›„ μ£Όμ” CPU μ†λΉ„μ² β…
1. syscall.Syscall6: 8.00s (35.56%)
2. WebRTC RTP μ „μ†΅: 8.78s (39.02%)
3. mDNS.readLoop: 4.26s (18.93%)
4. SRTP μ•”νΈν™”: 2.42s (10.76%)

**λ¶„μ„**:
- NACK CPU μ‚¬μ©λ‰ 8.60s β†’ 0s (μ™„μ „ μ κ±°)
- μ‹μ¤ν… μ½κ³Ό RTP μ „μ†΅μ΄ μ£Όμ” λ³‘λ©
- mDNSκ°€ μ•½κ°„ μ¦κ°€ν–μ§€λ§ μ „μ²΄μ μΌλ΅ μ•μ •μ 

### 4. κ³ λ£¨ν‹΄ μ λ³€ν™”

- **μµμ ν™” μ „**: 3,654κ°
- **μµμ ν™” ν›„**: 3,200κ°
- **κ°μ†**: 454κ° (12.4%)

μ£Όμ” κ³ λ£¨ν‹΄ λ¶„ν¬ (μµμ ν™” ν›„):
- counterdumper: 268κ°
- rtpsender: 152κ°
- OutgoingTrack: 152κ°
- ringbuffer.Pull: 139κ°

## μ¶”κ°€ μµμ ν™” κΈ°ν

### 1. mDNS λΉ„ν™μ„±ν™” (κ¶μ¥) β­β­

ν„μ¬ mDNSκ°€ 4.26s (18.93%) CPUλ¥Ό μ‚¬μ© μ¤‘μ…λ‹λ‹¤.

**κµ¬ν„**:
```go
// internal/protocols/webrtc/peer_connection.go
settingsEngine.SetICEMulticastDNSMode(ice.MulticastDNSModeDisabled)
```

**μμƒ ν¨κ³Ό**: CPU 15-20% μ¶”κ°€ κ°μ†

### 2. RTCP λ¦¬ν¬νΈ κ°„κ²© μ΅°μ • β­

**κµ¬ν„**:
```go
// internal/protocols/webrtc/outgoing_track.go
Period: 3 * time.Second, // 1μ΄ β†’ 3μ΄
```

**μμƒ ν¨κ³Ό**: CPU 5-10% μ¶”κ°€ κ°μ†

### 3. ν¨ν‚· λ°°μΉ μ²λ¦¬ (μ¥κΈ°) β­β­β­

syscall.Syscall6κ°€ 35.56% CPUλ¥Ό μ‚¬μ© μ¤‘ - ν¨ν‚· λ°°μΉ μ²λ¦¬λ΅ μ‹μ¤ν… μ½ νμ κ°μ† κ°€λ¥

**μμƒ ν¨κ³Ό**: CPU 10-15% μ¶”κ°€ κ°μ†

## ν’μ§ κ²€μ¦

### ν™•μΈλ μ‚¬ν•­ β…
- [x] NACK μΈν„°μ…‰ν„° μ™„μ „ μ κ±° ν™•μΈ
- [x] λ©”λ¨λ¦¬ 75% κ°μ† ν™•μΈ
- [x] CPU μ¤λ²„ν—¤λ“ μ κ±° ν™•μΈ
- [x] μ„λ²„ μ •μƒ μ‘λ™ μ¤‘

### λ¨λ‹ν„°λ§ ν•„μ” μ‚¬ν•­
- [ ] ν¨ν‚· μ†μ‹¤λ¥  μΈ΅μ •
- [ ] λΉ„λ””μ¤ ν’μ§ μ‹κ°μ  ν™•μΈ
- [ ] 24μ‹κ°„ μ•μ •μ„± ν…μ¤νΈ
- [ ] ν”Όν¬ μ‹κ°„λ€ μ„±λ¥ μΈ΅μ •

## λ°°ν¬ μ •λ³΄

### ν„μ¬ λ°°ν¬ μƒνƒ
- **μ„λ²„**: 27.102.205.67
- **ν¬νΈ**: 8117 (WebRTC), 9999 (pprof)
- **λ²„μ „**: NACK μµμ ν™” λ²„μ „
- **ν™•μΈ μΌμ‹**: 2025-12-04 11:57:05 KST

### λΉλ“ μ •λ³΄
- **Build ID**: a8a41e369d658ff0840e21886dce8099eb65d6d0
- **μ΄μ „ Build ID**: 5817abb77ef456216d8b45d2ee6592e10dbf8877

### λ°°ν¬ λ°©λ²•
λ„μ»¤ μ΄λ―Έμ§€λ΅ ν¨ν‚¤μ§• μ™„λ£:
- **νμΌ**: `mediamtx-nack-optimized.tar` (69 MB)
- **μ΄λ―Έμ§€**: `mediamtx:nack-optimized`
- **λ² μ΄μ¤ μ΄λ―Έμ§€**: Alpine 3.19
- **μ΄λ―Έμ§€ ν¬κΈ°**: 253 MB

### λ΅λ“ λ°©λ²•
```bash
# μ„λ²„μ—μ„ μ‹¤ν–‰
docker load -i mediamtx-nack-optimized.tar
docker run -d \
  --name mediamtx \
  -p 8117:8117 \
  -p 8118:8118/udp \
  -p 8119:8119 \
  -p 8120:8120 \
  -p 8121:8121 \
  -p 9999:9999 \
  -v /path/to/mediamtx.yml:/app/mediamtx.yml \
  -v /path/to/logs:/app/log \
  mediamtx:nack-optimized
```

## λ¨λ‹ν„°λ§ λ…λ Ήμ–΄

### μ‹¤μ‹κ°„ λ©”λ¨λ¦¬ ν™•μΈ
```bash
curl -s "http://27.102.205.67:9999/debug/pprof/heap" > heap.prof
go tool pprof -text heap.prof | head -20
```

### μ‹¤μ‹κ°„ CPU ν™•μΈ (10μ΄)
```bash
curl -s "http://27.102.205.67:9999/debug/pprof/profile?seconds=10" > cpu_quick.prof
go tool pprof -top cpu_quick.prof | head -30
```

### κ³ λ£¨ν‹΄ μ ν™•μΈ
```bash
curl -s "http://27.102.205.67:9999/debug/pprof/goroutine?debug=1" | head -1
```

### NACK ν™•μΈ (μ—†μ–΄μ•Ό μ •μƒ)
```bash
curl -s "http://27.102.205.67:9999/debug/pprof/profile?seconds=10" > verify.prof
go tool pprof -top verify.prof | grep -i nack
# μ¶λ ¥μ΄ μ—†μΌλ©΄ μ •μƒ β…
```

## κ²°λ΅ 

NACK μΈν„°μ…‰ν„° μ κ±°λ΅ λ‹¤μκ³Ό κ°™μ€ λ†€λΌμ΄ μ„±λ¥ κ°μ„ μ„ λ‹¬μ„±ν–μµλ‹λ‹¤:

### μ£Όμ” μ„±κ³Ό
1. β… **λ©”λ¨λ¦¬ 75% κ°μ†** (180 MB β†’ 44 MB)
2. β… **NACK μ¤λ²„ν—¤λ“ 100% μ κ±°** (8.60s β†’ 0s)
3. β… **ν¨ν‚· λ²„νΌ 114 MB μ™„μ „ μ κ±°**
4. β… **κ³ λ£¨ν‹΄ 12% κ°μ†** (3,654 β†’ 3,200κ°)

### μ¶”κ°€ μµμ ν™” μ μ¬λ ¥
- mDNS λΉ„ν™μ„±ν™”: +15-20% CPU μ κ°
- RTCP κ°„κ²© μ΅°μ •: +5-10% CPU μ κ°
- ν¨ν‚· λ°°μΉ: +10-15% CPU μ κ°

**μ΄ μ μ¬ κ°μ„ **: μµλ€ 45% μ¶”κ°€ CPU κ°μ† κ°€λ¥

### κ¶μ¥ μ‚¬ν•­
1. **λ‹¨κΈ°**: ν„μ¬ μ„±λ¥ λ¨λ‹ν„°λ§ (24μ‹κ°„)
2. **μ¤‘κΈ°**: mDNS λΉ„ν™μ„±ν™” μ μ©
3. **μ¥κΈ°**: ν¨ν‚· λ°°μΉ μ²λ¦¬ κµ¬ν„

---

**λ³΄κ³ μ„ μ‘μ„±**: 2025-12-04
**λ¶„μ„μ**: Claude Code
**μµμ ν™” λ²„μ „**: NACK Removed (Build: a8a41e369d658ff0840e21886dce8099eb65d6d0)
