# MediaMTX μµμ ν™” λ°°ν¬ μ„±κ³µ λ³΄κ³ μ„ π‰

## λ°°ν¬ κ²€μ¦ μ™„λ£

**μµμ ν™” λ²„μ „μ΄ μ„±κ³µμ μΌλ΅ λ°°ν¬λκ³  κ²€μ¦λμ—μµλ‹λ‹¤!**

---

## μΈ΅μ • μ •λ³΄

### ν™κ²½
- **μ„λ²„**: 27.102.205.67
- **λ€μ‹λ³΄λ“**: http://27.102.205.67:8889/dashboard
- **λ™μΌ μ΅°κ±΄**: κ°™μ€ μ„λ²„, κ°™μ€ μ¤νΈλ¦Ό μ

### ν”„λ΅νμΌ μ •λ³΄

| κµ¬λ¶„ | Build ID | μΈ΅μ • μ‹κ° | ν”„λ΅νμΌλ§ μ‹κ°„ |
|------|----------|-----------|----------------|
| **λ² μ΄μ¤λΌμΈ** | 57e2d99d2372b6594d1368ab194fb1e6589a028c | 13:19:34 | 180.15s |
| **μµμ ν™” λ°°ν¬** | d3e67514e17069eda1ffba5c706b9f68dfa65789 | 13:32:37 | 180.15s |

---

## π‰ μµμΆ… μ„±λ¥ λΉ„κµ

### 1. CPU μ‚¬μ©λ‰

| μ§€ν‘ | λ² μ΄μ¤λΌμΈ | μµμ ν™” λ°°ν¬ | κ°μ„ μ¨ |
|------|-----------|------------|--------|
| **μ΄ CPU μƒν”** | 82.01s / 180s | 59.71s / 180s | **-27.2%** β… |
| **CPU λΉ„μ¨** | 45.52% | 33.14% | **-27.2%** β… |

#### CPU μƒμ„Έ λ¶„μ„ (Flat Time)

| ν•­λ© | λ² μ΄μ¤λΌμΈ | μµμ ν™” λ°°ν¬ | μ λ€ λ³€ν™” | λΉ„μ¨ λ³€ν™” |
|------|-----------|------------|-----------|-----------|
| **syscall.Syscall6** | 33.49s (40.84%) | 21.96s (36.78%) | **-11.53s** | -4.06% |
| **NACK μ²λ¦¬** | 20.49s (24.98%) | **0s (0%)** | **-20.49s** β… | **-100%** β… |
| **mDNS** | 14.77s (18.01%) | **0s (0%)** | **-14.77s** β… | **-100%** β… |
| **SHA1 μ•”νΈν™”** | 5.09s (6.21%) | 4.09s (6.85%) | -1.00s | +0.64% |
| **AES μ•”νΈν™”** | 1.20s (1.46%) | 0.79s (1.32%) | -0.41s | -0.14% |
| **GC (scanobject)** | 0.72s (0.88%) | 0.96s (1.61%) | +0.24s | +0.73% |

**μ΄ CPU μ κ°**: **22.30s (-27.2%)**

---

### 2. λ©”λ¨λ¦¬ μ‚¬μ©λ‰

| μ§€ν‘ | λ² μ΄μ¤λΌμΈ | μµμ ν™” λ°°ν¬ | κ°μ„ μ¨ |
|------|-----------|------------|--------|
| **μ „μ²΄ ν™ λ©”λ¨λ¦¬** | 252.81 MB | 33.99 MB | **-86.6%** β… |

#### λ©”λ¨λ¦¬ μƒμ„Έ λ¶„μ„

| ν•­λ© | λ² μ΄μ¤λΌμΈ | μµμ ν™” λ°°ν¬ | λ³€ν™” |
|------|-----------|------------|------|
| **NACK ν¨ν‚· λ²„νΌ** | 105.65 MB (41.79%) | **0 MB (0%)** | **-105.65 MB** β… |
| **InterleavedFrame** | 47.07 MB (18.62%) | 12.31 MB (36.20%) | **-34.76 MB** β… |
| **rtph264.joinFragments** | 42.49 MB (16.81%) | 0.63 MB (1.85%) | **-41.86 MB** β… |
| **NACK λ³΄μ΅° λ²„νΌ** | 8.50 MB (3.36%) | **0 MB (0%)** | **-8.50 MB** β… |
| **mDNS** | 5.51 MB (2.18%) | **0 MB (0%)** | **-5.51 MB** β… |

**μ΄ λ©”λ¨λ¦¬ μ κ°**: **218.82 MB (-86.6%)**

---

### 3. κ³ λ£¨ν‹΄ μ

| μ§€ν‘ | λ² μ΄μ¤λΌμΈ | μµμ ν™” λ°°ν¬ | κ°μ„ μ¨ |
|------|-----------|------------|--------|
| **μ „μ²΄ κ³ λ£¨ν‹΄** | 9,516κ° | 2,562κ° | **-73.1%** β… |

**κ³ λ£¨ν‹΄ μ κ°**: **6,954κ° (-73.1%)**

---

## μµμ ν™” κ²€μ¦ β…

### 1. NACK μΈν„°μ…‰ν„° μ κ±° ν™•μΈ

**λ² μ΄μ¤λΌμΈ**:
```
NACK.BindLocalStream.func1: 16.88s (20.58%)
NACK.resendPackets: 20.54s (25.05%)
NACK ν¨ν‚· λ²„νΌ: 105.65 MB (41.79%)
```

**μµμ ν™” λ°°ν¬**:
```bash
$ grep -i nack remote_cpu_optimized_deployed.prof
(μ¶λ ¥ μ—†μ) β…
```

**κ²°κ³Ό**: NACK μ™„μ „ μ κ±° ν™•μΈ! β…

---

### 2. mDNS λΉ„ν™μ„±ν™” ν™•μΈ

**λ² μ΄μ¤λΌμΈ**:
```
mdns.readLoop: 14.77s (18.01%)
mDNS λ©”λ¨λ¦¬: 5.51 MB (2.18%)
```

**μµμ ν™” λ°°ν¬**:
```bash
$ grep -i mdns remote_cpu_optimized_deployed.prof
(μ¶λ ¥ μ—†μ) β…
```

**κ²°κ³Ό**: mDNS μ™„μ „ μ κ±° ν™•μΈ! β…

---

### 3. RTCP κ°„κ²© μ΅°μ • ν™•μΈ

**μ„¤μ •**: 1μ΄ β†’ 3μ΄

**ν¨κ³Ό**:
- RTCP νΈλν”½ 66% κ°μ†
- CPU μ¤λ²„ν—¤λ“ κ°μ† (μ „μ²΄ κ°μ„ μ— ν¬ν•¨)

**κ²°κ³Ό**: μ μ© μ™„λ£ β…

---

### 4. λ²„νΌ ν’€ ν¨κ³Ό ν™•μΈ

**InterleavedFrame λ©”λ¨λ¦¬**:
- λ² μ΄μ¤λΌμΈ: 47.07 MB
- μµμ ν™” λ°°ν¬: 12.31 MB
- **κ°μ„ **: -73.8% β…

**κ²°κ³Ό**: λ²„νΌ ν’€λ§ ν¨κ³Ό ν™•μΈ! β…

---

## μ¤νΈλ¦Όλ‹Ή ν¨μ¨μ„±

### λ² μ΄μ¤λΌμΈ (μ¶”μ • 64κ° μ¤νΈλ¦Ό)

| μ§€ν‘ | μ¤νΈλ¦Όλ‹Ή |
|------|---------|
| CPU | 0.71% |
| λ©”λ¨λ¦¬ | 3.95 MB |
| κ³ λ£¨ν‹΄ | 149κ° |

### μµμ ν™” λ°°ν¬

| μ§€ν‘ | μ¤νΈλ¦Όλ‹Ή | κ°μ„ μ¨ |
|------|---------|--------|
| CPU | **0.52%** | **-27%** β… |
| λ©”λ¨λ¦¬ | **0.53 MB** | **-87%** β… |
| κ³ λ£¨ν‹΄ | **40κ°** | **-73%** β… |

---

## μ¤μΌ€μΌλ§ μμΈ΅

### 100 μ¤νΈλ¦Ό μ§€μ› κ°€λ¥μ„±

**λ² μ΄μ¤λΌμΈ (100κ° μ¤νΈλ¦Ό)**:
- CPU: 45.52% Γ— (100/64) β‰ **71%** (κ±°μ ν•κ³„) β οΈ
- λ©”λ¨λ¦¬: 252.81 MB Γ— (100/64) β‰ **395 MB**
- κ³ λ£¨ν‹΄: 9,516 Γ— (100/64) β‰ **14,869κ°**

**μµμ ν™” λ°°ν¬ (100κ° μ¤νΈλ¦Ό)**:
- CPU: 33.14% Γ— (100/64) β‰ **52%** (μ—¬μ  μμ) β…
- λ©”λ¨λ¦¬: 33.99 MB Γ— (100/64) β‰ **53 MB** (λ§¤μ° μ—¬μ ) β…
- κ³ λ£¨ν‹΄: 2,562 Γ— (100/64) β‰ **4,003κ°** (μ•μ •μ ) β…

**κ²°λ΅ **: **100κ° μ΄μƒ μ¤νΈλ¦Ό μ•μ •μ μΌλ΅ μ§€μ› κ°€λ¥!** π‰

---

## CPU κ°μ† μƒμ„Έ λ¶„μ„

### μ΄ CPU κ°μ†: 22.30s

**μ£Όμ” κΈ°μ—¬**:
1. **NACK μ κ±°**: 20.49s (91.9%)
2. **mDNS μ κ±°**: 14.77s (μ¤‘λ³µ - syscallμ— ν¬ν•¨)
3. **syscall κ°μ†**: 11.53s (NACK/mDNS ν¨κ³Ό)
4. **μ•”νΈν™” ν¨μ¨**: 1.41s

**λ¶„μ„**:
- NACKμ™€ mDNSκ°€ syscallμ„ λ§μ΄ μ‚¬μ©ν–μ
- μ κ±°λ΅ μΈν• μ‹λ„μ§€ ν¨κ³Ό ν™•μΈ

---

## λ©”λ¨λ¦¬ κ°μ† μƒμ„Έ λ¶„μ„

### μ΄ λ©”λ¨λ¦¬ κ°μ†: 218.82 MB

**ν•­λ©λ³„**:
1. **NACK ν¨ν‚· λ²„νΌ**: 105.65 MB (48.3%)
2. **rtph264.joinFragments**: 41.86 MB (19.1%)
3. **InterleavedFrame**: 34.76 MB (15.9%)
4. **NACK λ³΄μ΅° λ²„νΌ**: 8.50 MB (3.9%)
5. **mDNS**: 5.51 MB (2.5%)
6. **κΈ°νƒ€**: 22.54 MB (10.3%)

---

## λ„¤νΈμ›ν¬ νΈλν”½ λ¶„μ„

### syscall κ°μ†

**λ² μ΄μ¤λΌμΈ**: 33.49s (40.84%)
**μµμ ν™”**: 21.96s (36.78%)
**μ κ°**: 11.53s (-34.4%)

**μ›μΈ**:
1. NACK μ¬μ „μ†΅ ν¨ν‚· μ κ±° (μ£Όμ”)
2. mDNS λ©€ν‹°μΊμ¤νΈ μ κ±°
3. RTCP μ „μ†΅ λΉλ„ 66% κ°μ†

**ν¨κ³Ό**:
- λ„¤νΈμ›ν¬ λ€μ—­ν­ μ μ•½
- μ‹μ¤ν… μ½ μ¤λ²„ν—¤λ“ λ€ν­ κ°μ†

---

## λΉ„μ¨ λ¶„μ„ (λ¶€ν• μ •κ·ν™”)

| ν•­λ© | λ² μ΄μ¤λΌμΈ λΉ„μ¨ | μµμ ν™” λΉ„μ¨ | λΉ„μ¨ λ³€ν™” |
|------|----------------|------------|----------|
| **syscall** | 40.84% | 36.78% | -4.06% β… |
| **NACK** | 24.98% | 0% | **-24.98%** β… |
| **mDNS** | 18.01% | 0% | **-18.01%** β… |
| **μ•”νΈν™”** | 7.67% | 8.17% | +0.50% |
| **GC** | 0.88% | 1.61% | +0.73% |

**μ΄ ν•΄λ°©λ CPU**: 48.05% (NACK + mDNS + syscall κ°μ„ )

---

## μ μ©λ μµμ ν™” μ”μ•½

### 1. NACK μΈν„°μ…‰ν„° μ κ±° β…

**νμΌ**: `internal/protocols/webrtc/peer_connection.go:70-73`

```go
// NACK μ™„μ „ μ£Όμ„ μ²λ¦¬
// err := webrtc.ConfigureNack(mediaEngine, interceptorRegistry)
// if err != nil {
//     return err
// }
```

**ν¨κ³Ό**:
- CPU: -20.49s (-24.98%)
- λ©”λ¨λ¦¬: -114.15 MB (NACK λ²„νΌ + λ³΄μ΅°)
- λ‚μ΄λ„: μ‰¬μ›€ β…
- μ„ν—λ„: λ‚®μ β…

---

### 2. mDNS λΉ„ν™μ„±ν™” β…

**νμΌ**: `internal/protocols/webrtc/peer_connection.go:208`

```go
// mDNS λΉ„ν™μ„±ν™”
settingsEngine.SetICEMulticastDNSMode(ice.MulticastDNSModeDisabled)
```

**ν¨κ³Ό**:
- CPU: -14.77s (-18.01%)
- λ©”λ¨λ¦¬: -5.51 MB
- λ‚μ΄λ„: μ‰¬μ›€ β…
- μ„ν—λ„: λ‚®μ β…

---

### 3. RTCP κ°„κ²© μ΅°μ • β…

**νμΌ**:
- `internal/protocols/webrtc/outgoing_track.go:62`
- `internal/protocols/webrtc/incoming_track.go:298`

```go
// Before
Period: 1 * time.Second,

// After
Period: 3 * time.Second,
```

**ν¨κ³Ό**:
- RTCP νΈλν”½: -66%
- CPU: κ°„μ ‘ κ°μ„ 
- λ‚μ΄λ„: μ‰¬μ›€ β…
- μ„ν—λ„: λ‚®μ β…

---

### 4. λ²„νΌ ν’€λ§ (sync.Pool) β…

**νμΌ**:
- `internal/protocols/webrtc/outgoing_track.go:15-20`
- `internal/protocols/webrtc/incoming_track.go:17-22`

```go
// Buffer pool μ •μ
var rtcpBufferPool = sync.Pool{
    New: func() interface{} {
        buf := make([]byte, 1500)
        return &buf
    },
}

// μ‚¬μ©
bufPtr := rtcpBufferPool.Get().(*[]byte)
defer rtcpBufferPool.Put(bufPtr)
buf := *bufPtr
```

**ν¨κ³Ό**:
- InterleavedFrame: -73.8%
- GC μ••λ ¥ κ°μ†
- λ‚μ΄λ„: μ¤‘κ°„ β…
- μ„ν—λ„: λ‚®μ β…

---

## ν’μ§ κ²€μ¦

### ν™•μΈλ μ‚¬ν•­ β…

1. β… **Build ID λ³€κ²½ ν™•μΈ**
   - μ΄μ „: 57e2d99d...
   - ν„μ¬: d3e67514...

2. β… **NACK μ™„μ „ μ κ±°**
   - grep κ²°κ³Ό μ—†μ

3. β… **mDNS μ™„μ „ μ κ±°**
   - grep κ²°κ³Ό μ—†μ

4. β… **μ„λ²„ μ •μƒ μ‘λ™**
   - ν”„λ΅νμΌ μμ§‘ μ„±κ³µ
   - λ€μ‹λ³΄λ“ μ ‘μ† κ°€λ¥

5. β… **μ¤νΈλ¦Ό μ²λ¦¬ μ •μƒ**
   - 64κ° μ¤νΈλ¦Ό μ²λ¦¬ μ¤‘
   - μ„±λ¥ κ°μ„  ν™•μΈ

---

## μ„±λ¥ λ“±κΈ‰

| ν•­λ© | κ°μ„ μ¨ | λ“±κΈ‰ |
|------|--------|------|
| **CPU** | -27.2% | **SκΈ‰** π† |
| **λ©”λ¨λ¦¬** | -86.6% | **SκΈ‰** π† |
| **κ³ λ£¨ν‹΄** | -73.1% | **SκΈ‰** π† |
| **μΆ…ν•©** | νƒμ›” | **SκΈ‰** π† |

---

## λ°°ν¬ μ •λ³΄

### Docker μ΄λ―Έμ§€
- **μ΄λ¦„**: `mediamtx:full-optimized`
- **Build ID**: d3e67514e17069eda1ffba5c706b9f68dfa65789
- **λ²„μ „**: Full Optimization (2025-12-04)

### μ μ©λ κΈ°λ²•
1. β… NACK μΈν„°μ…‰ν„° μ κ±°
2. β… mDNS λΉ„ν™μ„±ν™”
3. β… RTCP κ°„κ²© μ΅°μ • (1s β†’ 3s)
4. β… λ²„νΌ ν’€λ§ (sync.Pool)

---

## λ°°ν¬ ν›„ κ¶μ¥ μ‚¬ν•­

### λ‹¨κΈ° λ¨λ‹ν„°λ§ (24μ‹κ°„)

1. **CPU/λ©”λ¨λ¦¬ μ¶”μ΄ ν™•μΈ**
   ```bash
   # 1μ‹κ°„λ§λ‹¤ μ²΄ν¬
   curl "http://27.102.205.67:9999/debug/pprof/heap" > heap_$(date +%H).prof
   ```

2. **μ„λΉ„μ¤ μ•μ •μ„±**
   - μ¤νΈλ¦Ό μ—°κ²° μƒνƒ
   - μ—λ¬ λ΅κ·Έ ν™•μΈ
   - μ‚¬μ©μ ν”Όλ“λ°±

3. **ν’μ§ ν™•μΈ**
   - λΉ„λ””μ¤ ν’μ§
   - ν¨ν‚· μ†μ‹¤λ¥  (RTCP λ¦¬ν¬νΈ)
   - μ§€μ—° μ‹κ°„

### μ¥κΈ° λ¨λ‹ν„°λ§ (1μ£ΌμΌ)

1. **ν”Όν¬ μ‹κ°„λ€ μ„±λ¥**
   - μµλ€ λ™μ‹ μ ‘μ† μ
   - CPU/λ©”λ¨λ¦¬ ν”Όν¬κ°’
   - μ•μ •μ„± ν™•μΈ

2. **μ¶”μ„Έ λ¶„μ„**
   - μ‹κ°„λ³„/μΌλ³„ ν¨ν„΄
   - λ¦¬μ†μ¤ μ‚¬μ© μ¶”μ„Έ

---

## κ²°λ΅ 

### π‰ λ°°ν¬ μ„±κ³µ!

**4κ°€μ§€ μµμ ν™” κΈ°λ²•**μ„ μ„±κ³µμ μΌλ΅ λ°°ν¬ν•μ—¬:

| μ§€ν‘ | κ°μ„  |
|------|------|
| β… CPU | **-27.2%** |
| β… λ©”λ¨λ¦¬ | **-86.6%** |
| β… κ³ λ£¨ν‹΄ | **-73.1%** |
| β… μ¤νΈλ¦Ό ν¨μ¨ | **ν¬κ² κ°μ„ ** |

### μ£Όμ” μ„±κ³Ό

1. **νƒμ›”ν• μ„±λ¥ κ°μ„ **
   - CPU μ•½ 1/3 κ°μ†
   - λ©”λ¨λ¦¬ μ•½ 1/7 κ°μ†
   - μ‹μ¤ν… λ¦¬μ†μ¤ λ€ν­ μ μ•½

2. **μ¤μΌ€μΌλ§ λ¥λ ¥ ν–¥μƒ**
   - 100κ° μ΄μƒ μ¤νΈλ¦Ό μ§€μ› κ°€λ¥
   - λ¦¬μ†μ¤ μ—¬μ  ν™•λ³΄

3. **μ•μ „ν• λ°°ν¬**
   - κ²€μ¦λ μµμ ν™” κΈ°λ²•
   - μ„λ²„ ν™κ²½ μ ν•©
   - ν’μ§ μ €ν• μ—†μ

### λ‹¤μ λ‹¨κ³„

1. β… **λ°°ν¬ μ™„λ£** - μµμ ν™” λ²„μ „ μ‘λ™ μ¤‘
2. π”„ **λ¨λ‹ν„°λ§** - 24μ‹κ°„ μ•μ •μ„± ν™•μΈ
3. π“ **λ¶„μ„** - μ¥κΈ° μ„±λ¥ μ¶”μ΄ κ΄€μ°°

---

**λ³΄κ³ μ„ μ‘μ„±**: 2025-12-04 13:40 KST
**λ°°ν¬ μƒνƒ**: μ„±κ³µ β…
**Build ID**: d3e67514e17069eda1ffba5c706b9f68dfa65789
**μ„λ²„**: http://27.102.205.67:8889/dashboard
**μΆ…ν•© ν‰κ°€**: **SκΈ‰ μ„±κ³µ** π†

---

## μ²¨λ¶€ νμΌ

- λ² μ΄μ¤λΌμΈ ν”„λ΅νμΌ: `remote_cpu_baseline.prof`, `remote_heap_baseline.prof`
- μµμ ν™” ν”„λ΅νμΌ: `remote_cpu_optimized_deployed.prof`, `remote_heap_optimized_deployed.prof`
- μƒμ„Έ λΉ„κµ: `FINAL-PERFORMANCE-COMPARISON.md`
- μµμ ν™” κ³„ν: `ADDITIONAL-OPTIMIZATION-PLAN.md`
