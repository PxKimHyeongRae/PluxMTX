# MediaMTX μ„±λ¥ λ¶„μ„ λ° μµμ ν™” λ°©μ•

## λ¶„μ„ κ°μ”

- **λ¶„μ„ μΌμ‹**: 2025-12-04
- **ν”„λ΅νμΌ μμ§‘ κΈ°κ°„**: 180.12μ΄
- **μ¤νΈλ¦Ό μ**: 64κ°
- **μ£Όμ” μ¦μƒ**: CPU μ‚¬μ©λ‰ μ§€μ†μ  κ³ μ  μ μ§€, μ‹κ°„μ΄ μ§€λ‚λ„ κ°μ†ν•μ§€ μ•μ

## 1. ν”„λ΅νμΌ λ°μ΄ν„° μ”μ•½

### 1.1 CPU μ‚¬μ©λ‰ (server_cpu_profile.prof)
- **μ΄ μƒν” μ‹κ°„**: 80.73μ΄ (μ „μ²΄ μ‹κ°„μ 44.82%)
- **μ£Όμ” CPU μ†λΉ„ μ§€μ **:
  - `syscall.Syscall6`: 33.97s (42.08%) - λ„¤νΈμ›ν¬ I/O μ‹μ¤ν… μ½
  - WebRTC RTP μ „μ†΅ κ²½λ΅: 34.80s (43.11%)
    - `stream.(*Reader).run`: 34.80s
    - `webrtc.setupVideoTrack.func5`: 34.28s
    - `webrtc.(*OutgoingTrack).WriteRTPWithNTP`: 32.61s
  - mDNS μ½κΈ° λ£¨ν”„: 14.00s (17.34%)
  - SRTP μ•”νΈν™”: 9.29s (11.51%)

### 1.2 κ³ λ£¨ν‹΄ (Goroutine) λ¶„μ„
- **μ‹μ‘ μ‹μ **: 3,077κ°
- **μΆ…λ£ μ‹μ **: 2,540κ°
- **κ°μ†λ‰**: 537κ° (17.5% κ°μ†)

**64κ° μ¤νΈλ¦Ό κΈ°μ¤€ κ³ λ£¨ν‹΄ λ¶„ν¬**:
- μ¤νΈλ¦Όλ‹Ή ν‰κ·  ~40κ°μ κ³ λ£¨ν‹΄ μƒμ„±
- μ£Όμ” κ³ λ£¨ν‹΄ μ†λΉ„μ²:
  - `counterdumper.(*CounterDumper).run`: 261 β†’ 219
  - `rtpsender.(*Sender).run`: 142 β†’ 114
  - `statsInterceptor.BindRTCPReader`: 142 β†’ 114
  - `OutgoingTrack.setup`: 142 β†’ 114

### 1.3 ν™ λ©”λ¨λ¦¬ (Heap Memory) λ¶„μ„
- **μ‹μ‘**: 131.41 MB
- **μΆ…λ£**: 127.25 MB
- **κ°μ†λ‰**: 4.16 MB (3.2% κ°μ†)

**μ£Όμ” λ©”λ¨λ¦¬ μ†λΉ„μ²**:
1. `PacketFactoryCopy.func2`: 86.13 MB β†’ **91.63 MB** (μ¦κ°€!)
   - NACK μΈν„°μ…‰ν„°μ ν¨ν‚· λ²„νΌ
   - μ†μ‹¤λ ν¨ν‚· μ¬μ „μ†΅μ„ μ„ν• λ²„νΌ μ μ§€
2. `InterleavedFrame.Unmarshal`: 12.52 MB β†’ 8.01 MB
3. `PacketFactoryCopy.NewPacket`: 6.00 MB β†’ 2.00 MB

## 2. μ£Όμ” μ„±λ¥ λ¬Έμ μ 

### 2.1 NACK μΈν„°μ…‰ν„° μ¤λ²„ν—¤λ“ β οΈ (μµμ°μ„  λ¬Έμ )

**λ¬Έμ μ **:
- WebRTC NACK(Negative Acknowledgement) λ©”μ»¤λ‹μ¦μ΄ ν™μ„±ν™”λμ–΄ μμ
- μ†μ‹¤λ ν¨ν‚· μ¬μ „μ†΅μ„ μ„ν•΄ λ¨λ“  RTP ν¨ν‚·μ„ λ²„νΌμ— μ €μ¥
- 64κ° μ¤νΈλ¦Ό Γ— κ° μ¤νΈλ¦Όλ‹Ή ν¨ν‚· λ²„νΌ = μ•½ 91.63 MB λ©”λ¨λ¦¬ μ‚¬μ©
- CPU μ¤λ²„ν—¤λ“: ν¨ν‚· λ³µμ‚¬, λ²„νΌ κ΄€λ¦¬, NACK μ”μ²­ μ²λ¦¬

**μν–¥λ„**:
- λ©”λ¨λ¦¬: μ „μ²΄ ν™μ 72%
- CPU: RTP μ“°κΈ° κ²½λ΅μ μ£Όμ” λ³‘λ©

**μ½”λ“ μ„μΉ**:
```go
// internal/protocols/webrtc/peer_connection.go:70
err := webrtc.ConfigureNack(mediaEngine, interceptorRegistry)
```

### 2.2 κ³Όλ„ν• μ‹μ¤ν… μ½

**λ¬Έμ μ **:
- `syscall.Syscall6`μ΄ CPU μ‹κ°„μ 42%λ¥Ό μ°¨μ§€
- UDP ν¨ν‚·μ„ κ°λ³„μ μΌλ΅ μ „μ†΅ (ν¨ν‚·λ‹Ή 1λ²μ μ‹μ¤ν… μ½)
- 64κ° μ¤νΈλ¦Ό Γ— κ° μ¤νΈλ¦Όλ‹Ή μ΄λ‹Ή 25-30 ν”„λ μ„ Γ— ν¨ν‚· λ¶„ν•  = μ΄λ‹Ή μμ² λ²μ μ‹μ¤ν… μ½

**μν–¥λ„**:
- CPU: 42.08%
- μ»¨ν…μ¤νΈ μ¤μ„μΉ­ μ¤λ²„ν—¤λ“

### 2.3 mDNS μ¤λ²„ν—¤λ“

**λ¬Έμ μ **:
- ICE ν›„λ³΄ κ²€μƒ‰μ„ μ„ν• mDNS μ‚¬μ©
- `mdns.(*Conn).readLoop`κ°€ 14μ΄ (17.34%) CPU μ‹κ°„ μ†λΉ„
- λ΅μ»¬ λ„¤νΈμ›ν¬ ν›„λ³΄ κ²€μƒ‰μ—λ§ μ‚¬μ©λμ§€λ§ μ§€μ†μ μΌλ΅ μ‹¤ν–‰

**μν–¥λ„**:
- CPU: 17.34%
- λ€λ¶€λ¶„μ μ„λ²„ ν™κ²½μ—μ„ λ¶ν•„μ”

### 2.4 SRTP μ•”νΈν™” μ¤λ²„ν—¤λ“

**λ¬Έμ μ **:
- AES-CM + HMAC-SHA1 μ•”νΈν™”κ°€ κ° RTP ν¨ν‚·λ§λ‹¤ μν–‰
- CPU μ§‘μ•½μ  μ‘μ—… (SHA1 ν•΄μ‹±, AES μ•”νΈν™”)

**μν–¥λ„**:
- CPU: 11.51%
- μ΄λ” WebRTC ν‘μ¤€μ ν•„μ μ”κµ¬μ‚¬ν•­μΌλ΅ μµμ ν™” μ ν•μ 

### 2.5 κ³ λ£¨ν‹΄ κ³Όλ‹¤ μƒμ„±

**λ¬Έμ μ **:
- 64κ° μ¤νΈλ¦Όμ— λ€ν•΄ 2,540κ°μ κ³ λ£¨ν‹΄ μ μ§€
- μ¤νΈλ¦Όλ‹Ή ν‰κ·  ~40κ°μ κ³ λ£¨ν‹΄
- κ° κ³ λ£¨ν‹΄μ€ μµμ† 2KB μ¤νƒ λ©”λ¨λ¦¬ μ‚¬μ©

**μν–¥λ„**:
- λ©”λ¨λ¦¬: μ•½ 5-10 MB (μ¤νƒ + κ΄€λ¦¬ μ¤λ²„ν—¤λ“)
- μ¤μΌ€μ¤„λ¬ μ¤λ²„ν—¤λ“ μ¦κ°€

## 3. μµμ ν™” λ°©μ•

### 3.1 NACK μΈν„°μ…‰ν„° λΉ„ν™μ„±ν™” (μ¦‰μ‹ μ μ© κ°€λ¥) β­β­β­

**κΈ°λ€ ν¨κ³Ό**: λ©”λ¨λ¦¬ 70% κ°μ†, CPU 20-30% κ°μ†

**κµ¬ν„ λ°©λ²•**:

`internal/protocols/webrtc/peer_connection.go` μμ •:

```go
// registerInterceptors ν•¨μ μμ • (λΌμΈ 65-90)
func registerInterceptors(
	mediaEngine *webrtc.MediaEngine,
	interceptorRegistry *interceptor.Registry,
	onStatsInterceptor func(s *statsInterceptor),
) error {
	// NACK μΈν„°μ…‰ν„° λΉ„ν™μ„±ν™” (μ£Όμ„ μ²λ¦¬ λλ” μ κ±°)
	// err := webrtc.ConfigureNack(mediaEngine, interceptorRegistry)
	// if err != nil {
	// 	return err
	// }

	err := webrtc.ConfigureSimulcastExtensionHeaders(mediaEngine)
	if err != nil {
		return err
	}

	err = webrtc.ConfigureTWCCSender(mediaEngine, interceptorRegistry)
	if err != nil {
		return err
	}

	interceptorRegistry.Add(&statsInterceptorFactory{
		onCreate: onStatsInterceptor,
	})

	return nil
}
```

**νΈλ μ΄λ“μ¤ν”„**:
- μ¥μ : λ©”λ¨λ¦¬/CPU λ€ν­ κ°μ†
- λ‹¨μ : λ„¤νΈμ›ν¬ ν¨ν‚· μ†μ‹¤ μ‹ μ¬μ „μ†΅ λ¶κ°€
- κ³ λ ¤μ‚¬ν•­:
  - μ μ„  λ„¤νΈμ›ν¬ ν™κ²½μ—μ„λ” ν¨ν‚· μ†μ‹¤λ¥ μ΄ λ‚®μ•„ μν–¥ λ―Έλ―Έ
  - μ•μ •μ μΈ λ„¤νΈμ›ν¬ ν™κ²½μ΄λΌλ©΄ κ¶μ¥
  - ν¨ν‚· μ†μ‹¤μ΄ λ§μ€ ν™κ²½μ΄λΌλ©΄ μ‹ μ¤‘ν κ³ λ ¤

### 3.2 mDNS λΉ„ν™μ„±ν™” (μ¦‰μ‹ μ μ© κ°€λ¥) β­β­

**κΈ°λ€ ν¨κ³Ό**: CPU 15-20% κ°μ†

**κµ¬ν„ λ°©λ²•**:

`internal/protocols/webrtc/peer_connection.go` μμ •:

```go
// Start ν•¨μ λ‚΄λ¶€ (λΌμΈ 168 μ΄ν›„)
func (co *PeerConnection) Start() error {
	settingsEngine := webrtc.SettingEngine{}

	settingsEngine.SetIncludeLoopbackCandidate(true)

	// mDNS λΉ„ν™μ„±ν™” μ¶”κ°€
	settingsEngine.SetICEMulticastDNSMode(ice.MulticastDNSModeDisabled)

	// ... λ‚λ¨Έμ§€ μ½”λ“
}
```

**νΈλ μ΄λ“μ¤ν”„**:
- μ¥μ : CPU μ‚¬μ©λ‰ κ°μ†, λ¶ν•„μ”ν• λ©€ν‹°μΊμ¤νΈ νΈλν”½ μ κ±°
- λ‹¨μ : λ΅μ»¬ λ„¤νΈμ›ν¬ μλ™ κ²€μƒ‰ κΈ°λ¥ λΉ„ν™μ„±ν™” (μ„λ²„ ν™κ²½μ—μ„λ” λ³΄ν†µ λ¶ν•„μ”)z

### 3.3 RTCP λ¦¬ν¬νΈ κ°„κ²© μ΅°μ • (μ¦‰μ‹ μ μ© κ°€λ¥) β­

**κΈ°λ€ ν¨κ³Ό**: CPU 5-10% κ°μ†

**κµ¬ν„ λ°©λ²•**:

`internal/protocols/webrtc/outgoing_track.go` μμ •:

```go
// setup ν•¨μ λ‚΄λ¶€ (λΌμΈ 51-58)
t.rtcpSender = &rtpsender.Sender{
	ClockRate: int(t.track.Codec().ClockRate),
	Period:    3 * time.Second, // 1μ΄ β†’ 3μ΄λ΅ λ³€κ²½
	TimeNow:   time.Now,
	WritePacketRTCP: func(pkt rtcp.Packet) {
		p.wr.WriteRTCP([]rtcp.Packet{pkt}) //nolint:errcheck
	},
}
```

**νΈλ μ΄λ“μ¤ν”„**:
- μ¥μ : RTCP ν¨ν‚· μƒμ„±/μ „μ†΅ λΉλ„ κ°μ†
- λ‹¨μ : ν†µκ³„ μ—…λ°μ΄νΈ λΉλ„ κ°μ† (ν’μ§ λ¨λ‹ν„°λ§ μ •ν™•λ„ μ•½κ°„ κ°μ†)

### 3.4 UDP μ½κΈ° λ²„νΌ ν¬κΈ° μ¦κ°€ (μ„¤μ • λ³€κ²½) β­β­

**κΈ°λ€ ν¨κ³Ό**: ν¨ν‚· μ†μ‹¤ κ°μ†, μ‹μ¤ν… μ½ ν¨μ¨μ„± μ¦κ°€

**κµ¬ν„ λ°©λ²•**:

`mediamtx.yml` μμ •:

```yaml
# WebRTC μ„¤μ •μ— μ¶”κ°€
webrtc: yes
webrtcAddress: :8117
webrtcLocalUDPAddress: :8118
webrtcUDPReadBufferSize: 2097152  # 2MB (κΈ°λ³Έκ°’λ³΄λ‹¤ μ¦κ°€)
```

λλ” μ‹μ¤ν… λ λ²¨μ—μ„ μ„¤μ • (Linux):

```bash
# /etc/sysctl.conf μ— μ¶”κ°€
net.core.rmem_max = 2097152
net.core.wmem_max = 2097152
```

### 3.5 CPU ν”„λ΅νμΌ κΈ°λ° μµμ ν™” (μ¤‘κΈ° κ³„ν) β­β­β­

**ν¨ν‚· λ°°μΉ μ²λ¦¬**:
ν„μ¬ κ° RTP ν¨ν‚·μ„ κ°λ³„μ μΌλ΅ μ „μ†΅ν•λ” λ€μ‹  μ—¬λ¬ ν¨ν‚·μ„ λ¬¶μ–΄μ„ μ „μ†΅:

```go
// κ°λ…μ  κµ¬ν„ (μ‹¤μ  κµ¬ν„μ€ λ” λ³µμ΅ν•¨)
type PacketBatch struct {
	packets []*rtp.Packet
	mu      sync.Mutex
}

func (b *PacketBatch) Add(pkt *rtp.Packet) {
	b.mu.Lock()
	b.packets = append(b.packets, pkt)
	shouldFlush := len(b.packets) >= 10 || time.Since(lastFlush) > 5*time.Millisecond
	b.mu.Unlock()

	if shouldFlush {
		b.Flush()
	}
}
```

**μμƒ ν¨κ³Ό**: μ‹μ¤ν… μ½ 50% κ°μ†, CPU 10-15% κ°μ†

### 3.6 κ³ λ£¨ν‹΄ ν’€ μ‚¬μ© (μ¥κΈ° κ³„ν) β­

**κµ¬ν„ λ°©ν–¥**:
- μ›μ»¤ ν’€ ν¨ν„΄μΌλ΅ κ³ λ£¨ν‹΄ μ¬μ‚¬μ©
- μ¤νΈλ¦Όλ‹Ή κ³ λ£¨ν‹΄ μλ¥Ό 20κ° μ΄ν•λ΅ μ ν•

**μμƒ ν¨κ³Ό**: λ©”λ¨λ¦¬ 5-10 MB κ°μ†, GC μ••λ ¥ κ°μ†

### 3.7 ν•λ“μ›¨μ–΄ κ°€μ† ν™μ© (ν™κ²½ μμ΅΄μ ) β­β­

**ν™•μΈ μ‚¬ν•­**:
- CPUκ°€ AES-NI (AES λ…λ Ήμ–΄ μ„ΈνΈ)λ¥Ό μ§€μ›ν•λ”μ§€ ν™•μΈ
- Goμ crypto λΌμ΄λΈλ¬λ¦¬κ°€ μλ™μΌλ΅ AES-NIλ¥Ό μ‚¬μ©ν•μ§€λ§ ν™•μΈ ν•„μ”

**ν™•μΈ λ°©λ²•**:
```bash
# Linux
grep -m1 -o aes /proc/cpuinfo

# λΉλ“ μ‹ λ…μ‹μ μΌλ΅ AES-NI ν™μ„±ν™”
GOAMD64=v3 go build
```

## 4. κ¶μ¥ μ μ© μμ„

### Phase 1: μ¦‰μ‹ μ μ© (λ°°ν¬ ν›„ λ¨λ‹ν„°λ§)
1. **NACK μΈν„°μ…‰ν„° λΉ„ν™μ„±ν™”** (3.1)
   - μμƒ ν¨κ³Ό: λ©”λ¨λ¦¬ 70% κ°μ†, CPU 20-30% κ°μ†
   - λ¦¬μ¤ν¬: λ‚®μ (μ•μ •μ μΈ λ„¤νΈμ›ν¬ ν™κ²½)

2. **mDNS λΉ„ν™μ„±ν™”** (3.2)
   - μμƒ ν¨κ³Ό: CPU 15-20% κ°μ†
   - λ¦¬μ¤ν¬: λ§¤μ° λ‚®μ (μ„λ²„ ν™κ²½μ—μ„ λ¶ν•„μ”)

3. **RTCP λ¦¬ν¬νΈ κ°„κ²© μ΅°μ •** (3.3)
   - μμƒ ν¨κ³Ό: CPU 5-10% κ°μ†
   - λ¦¬μ¤ν¬: λ‚®μ

**μ΄ μμƒ ν¨κ³Ό**: CPU 40-60% κ°μ†, λ©”λ¨λ¦¬ 70% κ°μ†

### Phase 2: μ„¤μ • μµμ ν™” (1μ£ΌμΌ ν›„)
4. **UDP λ²„νΌ ν¬κΈ° μ¦κ°€** (3.4)
   - μ‹μ¤ν… μ„¤μ • λ³€κ²½ ν•„μ”
   - ν¨ν‚· μ†μ‹¤λ¥  λ¨λ‹ν„°λ§

### Phase 3: μ½”λ“ μµμ ν™” (1κ°μ›” ν›„)
5. **ν¨ν‚· λ°°μΉ μ²λ¦¬** (3.5)
6. **κ³ λ£¨ν‹΄ ν’€** (3.6)
7. **ν•λ“μ›¨μ–΄ κ°€μ† ν™•μΈ** (3.7)

## 5. λ¨λ‹ν„°λ§ μ§€ν‘

μµμ ν™” ν›„ λ‹¤μ μ§€ν‘λ¥Ό λ¨λ‹ν„°λ§ν•μ„Έμ”:

### μ„±λ¥ μ§€ν‘
- **CPU μ‚¬μ©λ¥ **: ν„μ¬ λ€λΉ„ 40-60% κ°μ† λ©ν‘
- **λ©”λ¨λ¦¬ μ‚¬μ©λ‰**: ν„μ¬ λ€λΉ„ 70% κ°μ† λ©ν‘
- **κ³ λ£¨ν‹΄ μ**: 2,540κ° β†’ 1,500κ° μ΄ν• λ©ν‘

### ν’μ§ μ§€ν‘
- **ν¨ν‚· μ†μ‹¤λ¥ **: NACK λΉ„ν™μ„±ν™” ν›„ λ¨λ‹ν„°λ§ ν•„μ
- **λΉ„λ””μ¤ ν’μ§**: μ‹κ°μ  ν’μ§ μ €ν• μ—†λ”μ§€ ν™•μΈ
- **μ§€μ—° μ‹κ°„**: λ μ΄ν„΄μ‹ λ³€ν™” λ¨λ‹ν„°λ§

### λ¨λ‹ν„°λ§ λ°©λ²•
```bash
# CPU/λ©”λ¨λ¦¬ λ¨λ‹ν„°λ§
top -p $(pgrep mediamtx)

# κ³ λ£¨ν‹΄ μ ν™•μΈ
curl http://localhost:9999/debug/pprof/goroutine?debug=1 | head -1

# ν”„λ΅νμΌλ§ μ¬μμ§‘
curl http://localhost:9999/debug/pprof/profile?seconds=60 > cpu_after.prof
curl http://localhost:9999/debug/pprof/heap > heap_after.prof
```

## 6. μμƒ μ„±λ¥ κ°μ„  μ”μ•½

| ν•­λ© | ν„μ¬ | μµμ ν™” ν›„ | κ°μ„ μ¨ |
|------|------|-----------|--------|
| CPU μ‚¬μ©λ‰ | λ†’μ (ν”Όν¬ μ§€μ†) | 40-60% κ°μ† | πΆ |
| λ©”λ¨λ¦¬ μ‚¬μ©λ‰ | 127 MB | 35-40 MB | πΆ 70% |
| κ³ λ£¨ν‹΄ μ | 2,540κ° | 1,500κ° μ΄ν• | πΆ 41% |
| ν¨ν‚· λ²„νΌ | 91.63 MB | 5 MB μ΄ν• | πΆ 95% |

## 7. μ°Έκ³  μλ£

- [Pion WebRTC Performance](https://github.com/pion/webrtc/wiki/Performance)
- [Go Profiling](https://go.dev/blog/pprof)
- [WebRTC Tuning](https://webrtcglossary.com/nack/)

## 8. κ²°λ΅ 

ν„μ¬ MediaMTX μ„λ²„μ μ£Όμ” μ„±λ¥ λ³‘λ©μ€ **NACK μΈν„°μ…‰ν„°μ ν¨ν‚· λ²„νΌλ§**μ…λ‹λ‹¤. μ΄λ¥Ό λΉ„ν™μ„±ν™”ν•λ” κ²ƒλ§μΌλ΅λ„ λ©”λ¨λ¦¬ μ‚¬μ©λ‰μ„ 70%, CPU μ‚¬μ©λ‰μ„ 20-30% μ¦‰μ‹ κ°μ†μ‹ν‚¬ μ μμµλ‹λ‹¤.

μ¶”κ°€λ΅ mDNS λΉ„ν™μ„±ν™”μ™€ RTCP κ°„κ²© μ΅°μ •μ„ μ μ©ν•λ©΄ CPU μ‚¬μ©λ‰μ„ μ΄ 40-60% κ°μ†μ‹ν‚¬ μ μμΌλ©°, μ΄λ” μ•μ •μ μΈ μ„λ²„ μ΄μμ— μ¶©λ¶„ν• κ°μ„  ν¨κ³Όλ¥Ό μ κ³µν•  κ²ƒμ…λ‹λ‹¤.

λ¨λ“  μµμ ν™”λ” λ‹¨κ³„μ μΌλ΅ μ μ©ν•κ³ , κ° λ‹¨κ³„λ§λ‹¤ μ„±λ¥κ³Ό ν’μ§ μ§€ν‘λ¥Ό λ¨λ‹ν„°λ§ν•μ—¬ μµμ μ μ„¤μ •μ„ μ°Ύλ” κ²ƒμ„ κ¶μ¥ν•©λ‹λ‹¤.
